@attribute [Authorize(Roles="Admin, SuperAdmin")]
@inject IJSRuntime js
@inject IHttpContextAccessor HttpContextAccessor
<div class="modal fade show" id="myModal" style="display:block; background-color: rgba(10,10,10,.8);"
     aria-modal="true" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">@Title</h4>
                <button type="button" class="close" @onclick="@ModalCancel">&times;</button>
            </div>
              <EditForm Model="@processRoles" OnValidSubmit="@SaveGeneralInformation" class="">                  
              <DataAnnotationsValidator/>
              <ValidationSummary/>
                <div class="modal-body">
                <p>@Text</p>               
                 <div class="form-group form-inline col-md-12">
                        <InputSelect @bind-Value="@RoleId" required class="form-control col-md-4">
                            <option selected value="">Select Aplicable Roles</option>
                            @if (GetAllRoles != null)
                            {
                                @foreach (var role in GetAllRoles)
                                {
                                    <option value="@role.RoleId.ToString()">@role.RoleName</option>
                                }
                            }
                            else
                            {
                                 <option selected value="">No Roles Found!</option>
                            }
                        </InputSelect>                
                        <InputSelect @bind-Value="@processRoles.UserId" required class="form-control col-md-4 ml-2">
                            <option selected value="">Select User</option>
                            @if (GetAllUsers != null)
                            {
                                @foreach (var user in GetAllUsers)
                                {
                                    <option value="@user.Id">@user.UserName</option>
                                }
                            }
                            else
                            {
                                 <option selected value="">No Users Found!</option>
                            }
                        </InputSelect>                        
                         <button type="button" class="btn btn-primary ml-2" @onclick="@SaveGeneralInformation">Save</button>
                 </div>
                <h3 class="mb-3 ">Roles Assigned</h3>
                    <table class="table table-striped table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th>Role</th>
                                <th>User</th>                              
                                    <th colspan="2">Actions</th>                                
                            </tr>
                        </thead>
                        <tbody>
                            @if (processAssRoles == null)
                            {
                                <tr>
                                    <td colspan="2">Loading...</td>
                                </tr>
                            }
                            else if (processAssRoles.Count() == 0)
                            {
                                <tr>
                                    <td colspan="2">No clauses assigned!</td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var g in processAssRoles)
                                {
                                    
                                <tr>
                                    <td>@g.Role.RoleName</td>
                                     <td>@g.User.UserName</td>                                  
                                         <td>
                                            <button class="btn btn-danger btn-sm" @onclick="@(async () => await MarkAsDeleted(g.RoleId))">Delete</button>  
                                        </td>                                    
                                </tr>
                                }
                            }
                        </tbody>
                    </table>
            </div>
            <div class="modal-footer align-content-center alert-@Alert">
               @Message
            </div>            
            </EditForm>           
        </div>
    </div>     
</div>

@code {
    QAD_QMSContext db = new QAD_QMSContext();
    DProcessRoles processRoles = new DProcessRoles();
    List<DProcessRoles> processAssRoles = new List<DProcessRoles>();
    AspNetUsers users = new AspNetUsers();
    IEnumerable<DRoles> GetAllRoles { get; set; }
    IEnumerable<AspNetUsers> GetAllUsers{ get; set; }
    [Parameter]
    public string Title { get; set; }
    [Parameter]
    public string Text { get; set; }

    [Parameter]
    public EventCallback<bool> OnClose { get; set; }
    [Parameter]
    public string ProcessId { get; set; }
    public string RoleId { get; set; }
    public int IdProcess { get; set; }
    public string Message { get; set; }
    public string Alert { get; set; } = "default";
    private Task ModalCancel()
    {
        return OnClose.InvokeAsync(false);
    }
    protected override async Task OnInitializedAsync()
    {
        GetAllRoles = await AllRoles();
        GetAllUsers = await GetAllUsersM();
        IdProcess = Convert.ToInt32(ProcessId);
        processAssRoles = await GetProcessRoles(IdProcess);
    }
    private Task ModalOk()
    {
        return OnClose.InvokeAsync(true);
    }
    private async Task<List<DRoles>> AllRoles()
    {
        return await db.DRoles.ToListAsync();
    }
    private async Task<List<AspNetUsers>> GetAllUsersM()
    {
        return await db.AspNetUsers.ToListAsync();
    }
    private async Task<List<DProcessRoles>> GetProcessRoles(int id)
    {
        return await db.DProcessRoles.Where(x => x.ProcessId == id).ToListAsync();
    }
    public async Task SaveGeneralInformation()
    {
        int roleId = Convert.ToInt32(RoleId);
        try
        {
            if(processRoles.ProcessId == 0)
            {
                var exists = await db.DProcessRoles.FirstOrDefaultAsync(x => x.RoleId == processRoles.RoleId && x.ProcessId == processRoles.ProcessId);
                processRoles.ProcessId = IdProcess;
                processRoles.RoleId = roleId;
                if (exists == null)
                {

                    db.DProcessRoles.Add(processRoles);
                }
                else
                {
                    await js.InvokeAsync<Task>("alert", "Role is already mapped to this user!");
                    processRoles = new DProcessRoles();
                    Message = "Process already has this role!";
                    Alert = "danger";
                    return;
                }
            }
            else
            {
                await js.InvokeAsync<Task>("alert", "Select a Role to map to this user!");
                processRoles = new DProcessRoles();
                Message = "Select a role first!";
                Alert = "danger";
                return;
            }
            await db.SaveChangesAsync();
            GetAllRoles = await AllRoles();
            processAssRoles = await GetProcessRoles(IdProcess);
            processRoles = new DProcessRoles();
            Message = "Role Assigned!";
            Alert = "success";
            //ModalOk();
        }
        catch (Exception ex)
        {
            ex.InnerException.ToString();
            ex.Message.ToString();
        }
    }
    protected async Task MarkAsDeleted(int id)
    {
        bool confirmed = await js.InvokeAsync<bool>("confirm", "Are you sure?");
        if (confirmed)
        {
            var processRoles = await db.DProcessRoles.FirstOrDefaultAsync(x => x.RoleId == id && x.ProcessId == IdProcess);
            db.DProcessRoles.Remove(processRoles);
            await db.SaveChangesAsync();
            processAssRoles = await GetProcessRoles(IdProcess);
            Message = "Role Deleted";
            Alert = "danger";
        }
    }
}